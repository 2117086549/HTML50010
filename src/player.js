Crafty.c("LeftControls",{init:function(){this.requires("Multiway")},leftControls:function(a){this.multiway(a,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180});return this}});Crafty.c("Dude",{Dude:function(){this.requires("SpriteAnimation, Collision, Grid").animate("walk_left",[[0,96],[32,96],[64,96]]).animate("walk_right",[[0,144],[32,144],[64,144]]).animate("walk_up",[[0,48],[32,48],[64,48]]).animate("walk_down",[[0,0],[32,0],[64,0]]);return this}});Player=ActorObject.extend({defaults:{tileMap:undefined,speed:2,pullSpeed:2,pushDistance:64*64,pushRepelAmount:25,pullID:undefined,animSpeed:8,spriteHeight:48,spriteHalfHeight:24,spriteHalfWidth:16,"z-index":10,carrotsCount:_Globals.conf.get("defaultCarrots"),},initialize:function(){var b=this;b.set("sprite-z",b.get("spriteHeight")+b.get("z-index"));var d={none:0,down:1,up:2};var c=b.get("tileMap").spawnAtCentre();var a=Crafty.e("2D, "+_Globals.conf.get("renderType")+", Dude, player, LeftControls").attr({move:{left:false,right:false,up:false,down:false},digCarrot:{canPull:false,obj:undefined},pullBars:{red:undefined,green:undefined},actions:{action1:d.none,action2:d.none},x:c.x,y:c.y,z:b.get("sprite-z"),walk_start_frame:null,speed:b.get("speed")}).Dude().bind("KeyDown",function(f){if(f.keyCode===Crafty.keys.RIGHT_ARROW){this.move.right=true}else{if(f.keyCode===Crafty.keys.LEFT_ARROW){this.move.left=true}else{if(f.keyCode===Crafty.keys.UP_ARROW){this.move.up=true}else{if(f.keyCode===Crafty.keys.DOWN_ARROW){this.move.down=true}else{if(f.keyCode===Crafty.keys.Z||f.keyCode===Crafty.keys.Y){this.actions.action1=d.down}}}}}}).bind("KeyUp",function(f){if(f.keyCode===Crafty.keys.RIGHT_ARROW){this.move.right=false}else{if(f.keyCode===Crafty.keys.LEFT_ARROW){this.move.left=false}else{if(f.keyCode===Crafty.keys.UP_ARROW){this.move.up=false}else{if(f.keyCode===Crafty.keys.DOWN_ARROW){this.move.down=false}else{if(f.keyCode===Crafty.keys.Z||f.keyCode===Crafty.keys.Y){this.actions.action1=d.up}else{if(f.keyCode===Crafty.keys.Q){this.trigger("PushEnemies")}else{if(f.keyCode===Crafty.keys.W){this.trigger("ForkEnemies")}}}}}}}}).bind("EnterFrame",function(i){var h=this.x;var g=this.y;var f=this.move.up||this.move.down||this.move.left||this.move.right;if(this.move.up){this.y-=this.speed}if(this.move.down){this.y+=this.speed}if(this.move.left){this.x-=this.speed}if(this.move.right){this.x+=this.speed}if(f){if(this.move.left){if(!this.isPlaying("walk_left")){this.stop().animate("walk_left",b.get("animSpeed"),-1)}}else{if(this.move.right){if(!this.isPlaying("walk_right")){this.stop().animate("walk_right",b.get("animSpeed"),-1)}}else{if(this.move.up){if(!this.isPlaying("walk_up")){this.stop().animate("walk_up",b.get("animSpeed"),-1)}}else{if(this.move.down){if(!this.isPlaying("walk_down")){this.stop().animate("walk_down",b.get("animSpeed"),-1)}}}}}}else{this.stop()}if(this.digCarrot.canPull){this.trigger("UpdatePullBar",this.digCarrot.obj.health);if(this.actions.action1===d.down){if(this.digCarrot.obj&&!this.digCarrot.obj.pulled){this.digCarrot.obj.health-=b.get("pullSpeed");if(this.digCarrot.obj.health<=0){this.actions.action1=d.none;b.set("carrotsCount",b.get("carrotsCount")+_Globals.conf.get("carrotsCollect"));this.digCarrot.obj.pulled=true;this.digCarrot.obj.destroy();this.digCarrot.canPull=false;this.trigger("HidePullBar");Crafty.trigger("UpdateStats");Crafty.trigger("ShowMsg","clear");if(_Globals.conf.get("sfx")){Crafty.audio.play("pull",1,_Globals.conf.get("sfx_vol"))}b.set("pullID",undefined)}}}}if(this.hit("Layer2Tile")||this.x+32>Crafty.viewport.width||this.x<0||this.y+32>Crafty.viewport.height||this.y<-16){if(_Globals.conf.get("trace")){console.log("Player: Hit object or wall")}this.attr({x:h,y:g});return}var e=this.hit("carrot");if(e){if(!this.digCarrot.canPull){this.digCarrot.canPull=true;this.digCarrot.obj=e[0].obj;b.set("pullID",this.digCarrot.obj[0]);this.trigger("ShowPullBar",this.digCarrot.obj)}}else{if(this.digCarrot.canPull){this.digCarrot.canPull=false;this.digCarrot.obj=undefined;b.set("pullID",undefined);this.trigger("HidePullBar")}}this.attr({z:this.y+b.get("sprite-z")})}).bind("PushEnemies",function(){if(!b.eatCarrots(_Globals.conf.get("carrotsPushCost"))){return}var e=Crafty("Enemy");if(e&&e.length>0){var g=this.x+b.get("spriteHalfWidth");var f=this.y+b.get("spriteHalfHeight");Crafty.e("MagicPush").MagicPush({x:g,y:f});if(_Globals.conf.get("sfx")){if(Date.now()%2==0){Crafty.audio.play("fart1",1,_Globals.conf.get("sfx_vol"))}else{Crafty.audio.play("fart2",1,_Globals.conf.get("sfx_vol"))}}_.each(e,function(j){var k=Crafty(j);var i=k.x-g;var h=k.y-f;var m=(i*i+h*h);if(m<b.get("pushDistance")){var l={amount:b.get("pushRepelAmount"),x:g,y:f};k.trigger("PushBack",l);if(_Globals.conf.get("sfx")){if(Date.now()%2==0){Crafty.audio.play("scream1",1,_Globals.conf.get("sfx_vol"))}else{Crafty.audio.play("scream2",1,_Globals.conf.get("sfx_vol"))}}}})}}).bind("ForkEnemies",function(){if(Crafty("MagicFork").length>0){return}if(!b.eatCarrots(_Globals.conf.get("carrotsForkCost"))){return}if(_Globals.conf.get("sfx")){Crafty.audio.play("aaaah",1,_Globals.conf.get("sfx_vol"))}var e=Crafty("Enemy");if(e&&e.length>0){var f={x:this.x+b.get("spriteHalfWidth"),y:this.y+b.get("spriteHalfHeight")};Crafty.e("MagicFork").MagicPush(f).bind("EnterFrame",function(g){if(g.frame>this._createdOn){this._anim.stop();this._anim.destroy();this.destroy()}});_.each(e,function(g){var h=Crafty(g);h.trigger("ForkBeacon",f)})}}).bind("ShowPullBar",function(e){this.pullBars.red=Crafty.e("2D, "+_Globals.conf.get("renderType")+", Color").attr({x:e.x,y:e.y-5,w:32,h:5,z:998}).color("#aa0000");this.pullBars.green=Crafty.e("2D, "+_Globals.conf.get("renderType")+", Color").attr({x:e.x,y:e.y-5,w:0.32*e.health,h:5,z:999}).color("#00aa00")}).bind("HidePullBar",function(e){if(this.pullBars.red){this.pullBars.red.destroy();this.pullBars.red=undefined}if(this.pullBars.green){this.pullBars.green.destroy();this.pullBars.green=undefined}}).bind("UpdatePullBar",function(e){if(this.pullBars.green&&e>=0){this.pullBars.green.w=0.32*e}}).collision([8,40],[24,40],[24,48],[8,48]);b.set({entity:a})},eatCarrots:function(a){if(this.get("carrotsCount")<a){Crafty.trigger("ShowMsg","carrots");if(_Globals.conf.get("sfx")){Crafty.audio.play("burp",1,_Globals.conf.get("sfx_vol"))}return false}this.set("carrotsCount",this.get("carrotsCount")-a);Crafty.trigger("UpdateStats");return true}});