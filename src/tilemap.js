Crafty.c("Layer2Tile",{init:function(){}});Tilemap=ActorObject.extend({defaults:{pxWidth:_Globals.conf.get("screen-width"),pxHeight:_Globals.conf.get("screen-height"),tileSize:64,width:_Globals.conf.get("screen-width")/64,height:_Globals.conf.get("screen-height")/64,spawnArea:undefined,"base-z":10,maxObstacles:27,carrotHeightOffset:16,maxCarrots:_Globals.conf.get("maxCarrotsToSpawn"),carrotHealth:100,obstaclesCoords:undefined,obstaclesMap:undefined,carrotsCoordsQueue:[],},initialize:function(){var k=this;k.set("spawnArea",{top:1,left:1,right:k.get("width")-2,bottom:k.get("height")-2});k.set("spawnAreaPx",{top:k.get("tileSize")*k.get("spawnArea").top,left:k.get("tileSize")*k.get("spawnArea").left,right:k.get("tileSize")*k.get("spawnArea").right,bottom:k.get("tileSize")*k.get("spawnArea").bottom});for(var h=0;h<k.get("width");h++){for(var f=0;f<k.get("height");f++){var g=Crafty.e("2D,"+_Globals.conf.get("renderType")+", grass").attr({x:h*k.get("tileSize"),y:f*k.get("tileSize"),z:0})}}var b=[];for(var h=0;h<k.get("maxObstacles");h++){var m=Crafty.math.randomInt(1,6);var l=false;var d;var c;var a;var e="";do{d=Crafty.math.randomInt(k.get("spawnArea").left,k.get("spawnArea").right);c=Crafty.math.randomInt(k.get("spawnArea").top,k.get("spawnArea").bottom);l=_.size(_.where(b,{x:d,y:c}))>0;if(_Globals.conf.get("debug")&&l){console.log("Calculate new obstalce position for "+h)}}while(l);b.push({x:d,y:c});d*=k.get("tileSize");c*=k.get("tileSize");if(m==1){e="stone_small";a=k.get("base-z")+c+k.get("tileSize")-16}else{if(m==2){e="stone_big";a=k.get("base-z")+c+k.get("tileSize")-8}else{if(m==3){e="tree";a=k.get("base-z")+c+k.get("tileSize")}else{if(m==4){e="barrel";a=k.get("base-z")+c+k.get("tileSize")-16}else{if(m==5){e="bush";a=k.get("base-z")+c+k.get("tileSize")-16}else{if(m==6){e="heysack";a=k.get("base-z")+c+k.get("tileSize")}else{continue}}}}}}var g=Crafty.e("2D, "+_Globals.conf.get("renderType")+", "+e+", Collision, Layer2Tile").attr({x:d,y:c,z:a});if(m==1){g.collision([16,40],[48,40],[48,48],[16,48])}else{if(m==2){g.collision([16,40],[48,40],[48,48],[16,48])}else{if(m==3||m==6){g.collision([12,52],[56,52],[56,64],[12,64])}else{if(m==4||m==5){g.collision([16,40],[48,40],[48,48],[16,48])}}}}}k.set("obstaclesCoords",b);var p=[];for(var n=0;n<k.get("height");n++){var q=[];for(var o=0;o<k.get("width");o++){q.push(GraphNodeType.OPEN)}p.push(q)}_.each(b,function(i){p[i.y][i.x]=GraphNodeType.WALL});k.set("obstaclesMap",new Graph(p))},getPathToTile:function(e,d){var b=this.get("obstaclesMap");e.x=e.x<0?0:e.x;e.x=e.x>=this.get("width")?this.get("width")-1:e.x;e.y=e.y<0?0:e.y;e.y=e.y>=this.get("height")?this.get("height")-1:e.y;e.x=Math.floor(e.x);e.y=Math.floor(e.y);d.x=Math.floor(d.x);d.y=Math.floor(d.y);var c=b.nodes[e.y][e.x];var a=b.nodes[d.y][d.x];return astar.search(b.nodes,c,a,true)},getPathToTilePx:function(c,b){var a=this.get("tileSize");c.x/=a;c.y/=a;b.x/=a;b.y/=a;return this.getPathToTile(c,b)},spawnCarrot:function(){if(Crafty("carrot").length<this.get("maxCarrots")){var e=false;var h,d,b;do{var f=Crafty.math.randomInt(this.get("spawnArea").left,this.get("spawnArea").right);var c=Crafty.math.randomInt(this.get("spawnArea").top,this.get("spawnArea").bottom);h=this.spawnAt(f,c);d=h.x/this.get("tileSize");b=h.y/this.get("tileSize");var g=this.get("carrotsCoordsQueue");e=_.size(_.where(g,{x:d,y:b}))==0;if(_Globals.conf.get("debug")&&!e){console.log("Carrot coords %d,%d already used!",d,b)}}while(!e);g.push({x:d,y:b});if(g.length>8){g.pop()}var a=this.get("base-z")+24+h.y+1;Crafty.e("2D, "+_Globals.conf.get("renderType")+", carrot, SpriteAnimation, Collision").attr({x:h.x,y:h.y,z:a,health:this.get("carrotHealth"),pulled:false,occupied:false,startFrame:Crafty.frame()+500,}).reel("wind",450,[[0,0],[1,0],[2,0],[1,0]]).animate("wind",-1)}},spawnAt:function(a,j){var d=a,c=j;var f=false;var h=[1,0,-1,0];var g=[0,1,0,-1];var e=0,b=1;do{f=_.size(_.where(this.get("obstaclesCoords"),{x:d,y:c}))>0;if(f){if(_Globals.conf.get("trace")){console.log("spawnAt: Cannot spawn at "+d+","+c)}d=a+h[e]*b;c=j+g[e]*b;if(++e>3){e=0;b++}}}while(f);return{x:d*this.get("tileSize"),y:c*this.get("tileSize")}},spawnAtPx:function(b,a){return this.spawnAt(b/this.get("tileSize"),a/this.get("tileSize"))},spawnAtCentre:function(){return this.spawnAt(this.get("width")*0.5,this.get("height")*0.5)},spawnAtRandom:function(){var b=Crafty.math.randomInt(this.get("spawnArea").left,this.get("spawnArea").right);var a=Crafty.math.randomInt(this.get("spawnArea").top,this.get("spawnArea").bottom);return this.spawnAt(b,a)},spawnRelativeTo:function(f,e){var h,g;var c=f-this.get("spawnAreaPx").left;var b=this.get("spawnAreaPx").right-f;if(c<b){h=Crafty.math.randomInt(0,this.get("spawnArea").left)}else{h=Crafty.math.randomInt(this.get("spawnArea").right,this.get("spawnArea").right+2)}var a=e-this.get("spawnAreaPx").top;var d=this.get("spawnAreaPx").bottom-e;if(a<d){g=Crafty.math.randomInt(0,this.get("spawnArea").top)}else{g=Crafty.math.randomInt(this.get("spawnArea").bottom,this.get("spawnArea").bottom+2)}h*=this.get("tileSize");g*=this.get("tileSize");return{x:h,y:g}},spawnRelativeToEdge:function(c){if(!c||c=="random"){var a=["topleft","topright","bottomleft","bottomright"];var b=Crafty.math.randomInt(0,3);return this.spawnRelativeToEdge(a[b])}if(c=="topleft"){return this.spawnRelativeTo(this.get("spawnAreaPx").left,this.get("spawnAreaPx").top)}else{if(c=="topright"){return this.spawnRelativeTo(this.get("spawnAreaPx").right,this.get("spawnAreaPx").top)}else{if(c=="bottomleft"){return this.spawnRelativeTo(this.get("spawnAreaPx").left,this.get("spawnAreaPx").bottom)}else{if(c=="bottomright"){return this.spawnRelativeTo(this.get("spawnAreaPx").right,this.get("spawnAreaPx").bottom)}}}}},findFreeCarrot:function(e){if(e){var d=Crafty("carrot");var b=undefined;var c=18437736874454810000;_.each(d,function(f){var j=Crafty(f);if(j&&!j.occupied){var h=(j.x+16)-(e.x+16);var g=(j.y+24)-(e.y+48);var i=(h*h)+(g*g);if(i<c){c=i;b=j}}});return b}else{var d=_.shuffle(Crafty("carrot"));var a=_.find(d,function(f){var g=Crafty(f);return(g!=undefined)&&(!g.occupied)});if(b!=undefined){return Crafty(b)}}}});