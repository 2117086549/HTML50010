var Hiscore=Backbone.Model.extend({defaults:{},initialize:function(){},open:function(a){if(!GJAPI||!GJAPI.bActive){console.error("Gamejolt login not active!")}else{console.log("Gamejolt user "+GJAPI.sUserName)}},save:function(a,b){if(GJAPI){if(GJAPI.bActive){GJAPI.ScoreAdd(_Globals.conf.get("tid"),a,a+" carrots","",function(c){if(c&&!!!c.success){console.error("Error writing score!",c.message);b&&b(null)}else{b&&b(true)}})}else{GJAPI.ScoreAddGuest(_Globals.conf.get("tid"),a,a+" carrots","Guest","",function(c){if(c&&!!!c.success){console.error("Error writing score!",c.message);b&&b(null)}else{b&&b(true)}})}}else{b&&b(null)}},getAllScores:function(b){var a=[];if(GJAPI){GJAPI.ScoreFetch(_Globals.conf.get("tid"),GJAPI.SCORE_ALL,50,function(d){if(d&&!!!d.success){console.error("Error fetching scores!",d.message);b&&b(null)}else{for(var c=0;c<d.scores.length;c++){var e=d.scores[c];a.push({name:(e.user?e.user:e.guest),score:e.sort})}b&&b(a)}})}else{b&&b(null)}}});Crafty.bind("ShowSaveHiscore",function(a){$("#dialog-save-score").dialog({resizable:false,width:400,height:300,modal:false,title:"Save Hiscore",zIndex:20,open:function(){if(GJAPI&&GJAPI.bActive){$(this).html("Publish your score to Gamejolt?")}else{$(this).html("Publish your score as 'Guest' to Gamejolt?")}},buttons:{Yes:function(){var b=_Globals.hiscore;b.save(a,function(c){if(c){Crafty.trigger("ShowHiscore",{text:undefined,refresh:true})}else{Crafty.trigger("ShowHiscore",{text:"Failed saving your score! Sorry :(",refresh:true})}});$(this).dialog("close")},No:function(){$(this).dialog("close");Crafty.trigger("ShowHiscore",{text:undefined,refresh:true})}},})});Crafty.bind("ShowHiscore",function(a){$("#dialog-score").dialog({resizable:false,width:400,minHeight:520,height:520,modal:true,position:"top",title:"Top 50 Scores",open:function(){$("#dialog-score").css({height:"520px"});if(!a.text){$("#dialog-score").html("<p>Please wait while loading scores ...</p>");var b=_Globals.hiscore;var c="<div>";c+='<span class="name u">';c+="Name";c+="</span>";c+='<span class="score u">';c+="Carrots";c+="</span>";c+="</div>";b.getAllScores(function(e,d){if(!e){c+="<div>";c+='<span class="name">';c+="Failed loading scores!";c+="</span>";c+='<span class="score">';c+="</span>";c+="</div>"}else{_.each(e,function(g,f){if(++f>50){return}c+="<div>";c+='<span class="name">';c+=f+". ";c+=g.name;c+="</span>";c+='<span class="score">';c+=g.score;c+="</span>";c+="</div>"})}$("#dialog-score").html(c)});return}else{$("#dialog-score").html(a.text)}},buttons:{"Refresh Scores":function(){$(this).dialog("close");Crafty.trigger("ShowHiscore",a)},"Let me out!":function(){if(a.refresh){Crafty.audio.stop("music");Crafty.init();Crafty.scene(_Globals.scene)}$(this).dialog("close")}}})});